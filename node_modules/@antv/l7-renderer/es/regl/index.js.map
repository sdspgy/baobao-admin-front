{"version":3,"sources":["../../src/regl/index.ts"],"names":["injectable","regl","ReglAttribute","ReglBuffer","ReglElements","ReglFramebuffer","ReglModel","ReglTexture2D","ReglRendererService","gl","$container","createModel","options","createAttribute","createBuffer","createElements","createTexture2D","createFramebuffer","useFramebuffer","framebuffer","drawCommands","get","clear","color","depth","stencil","reglClearOptions","viewport","x","y","width","height","renderCanvas","getElementsByTagName","style","_gl","_refresh","readPixels","readPixelsOptions","read","getViewportSize","drawingBufferWidth","drawingBufferHeight","getContainer","destroy","cfg","Promise","resolve","reject","container","attributes","alpha","antialias","premultipliedAlpha","preserveDrawingBuffer","extensions","optionalExtensions","profile","onDone","err","r"],"mappings":"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","sourcesContent":["/**\n * render w/ regl\n * @see https://github.com/regl-project/regl/blob/gh-pages/API.md\n */\nimport {\n  IAttribute,\n  IAttributeInitializationOptions,\n  IBuffer,\n  IBufferInitializationOptions,\n  IClearOptions,\n  IElements,\n  IElementsInitializationOptions,\n  IFramebuffer,\n  IFramebufferInitializationOptions,\n  IModel,\n  IModelInitializationOptions,\n  IReadPixelsOptions,\n  IRenderConfig,\n  IRendererService,\n  ITexture2D,\n  ITexture2DInitializationOptions,\n} from '@antv/l7-core';\nimport { injectable } from 'inversify';\nimport regl from 'regl';\nimport ReglAttribute from './ReglAttribute';\nimport ReglBuffer from './ReglBuffer';\nimport ReglElements from './ReglElements';\nimport ReglFramebuffer from './ReglFramebuffer';\nimport ReglModel from './ReglModel';\nimport ReglTexture2D from './ReglTexture2D';\n\n/**\n * regl renderer\n */\n@injectable()\nexport default class ReglRendererService implements IRendererService {\n  private gl: regl.Regl;\n  private $container: HTMLDivElement | null;\n\n  public async init(\n    $container: HTMLDivElement,\n    cfg: IRenderConfig,\n  ): Promise<void> {\n    this.$container = $container;\n    // tslint:disable-next-line:typedef\n    this.gl = await new Promise((resolve, reject) => {\n      regl({\n        container: $container,\n        attributes: {\n          alpha: true,\n          // use TAA instead of MSAA\n          // @see https://www.khronos.org/registry/webgl/specs/1.0/#5.2.1\n          antialias: cfg.antialias,\n          premultipliedAlpha: true,\n          preserveDrawingBuffer: cfg.preserveDrawingBuffer,\n        },\n        // TODO: use extensions\n        extensions: [\n          'OES_element_index_uint',\n          'OES_standard_derivatives', // wireframe\n          'angle_instanced_arrays', // VSM shadow map\n        ],\n        optionalExtensions: [\n          'oes_texture_float_linear',\n          'OES_texture_float',\n          'EXT_texture_filter_anisotropic',\n          'EXT_blend_minmax',\n          'WEBGL_depth_texture',\n        ],\n        profile: true,\n        onDone: (err: Error | null, r?: regl.Regl | undefined): void => {\n          if (err || !r) {\n            reject(err);\n          }\n          resolve(r);\n        },\n      });\n    });\n  }\n\n  public createModel = (options: IModelInitializationOptions): IModel =>\n    new ReglModel(this.gl, options);\n\n  public createAttribute = (\n    options: IAttributeInitializationOptions,\n  ): IAttribute => new ReglAttribute(this.gl, options);\n\n  public createBuffer = (options: IBufferInitializationOptions): IBuffer =>\n    new ReglBuffer(this.gl, options);\n\n  public createElements = (\n    options: IElementsInitializationOptions,\n  ): IElements => new ReglElements(this.gl, options);\n\n  public createTexture2D = (\n    options: ITexture2DInitializationOptions,\n  ): ITexture2D => new ReglTexture2D(this.gl, options);\n\n  public createFramebuffer = (options: IFramebufferInitializationOptions) =>\n    new ReglFramebuffer(this.gl, options);\n\n  public useFramebuffer = (\n    framebuffer: IFramebuffer | null,\n    drawCommands: () => void,\n  ) => {\n    this.gl({\n      framebuffer: framebuffer ? (framebuffer as ReglFramebuffer).get() : null,\n    })(drawCommands);\n  };\n\n  public clear = (options: IClearOptions) => {\n    // @see https://github.com/regl-project/regl/blob/gh-pages/API.md#clear-the-draw-buffer\n    const { color, depth, stencil, framebuffer = null } = options;\n    const reglClearOptions: regl.ClearOptions = {\n      color,\n      depth,\n      stencil,\n    };\n\n    reglClearOptions.framebuffer =\n      framebuffer === null\n        ? framebuffer\n        : (framebuffer as ReglFramebuffer).get();\n\n    this.gl.clear(reglClearOptions);\n  };\n\n  public viewport = ({\n    x,\n    y,\n    width,\n    height,\n  }: {\n    x: number;\n    y: number;\n    width: number;\n    height: number;\n  }) => {\n    // use WebGL context directly\n    // @see https://github.com/regl-project/regl/blob/gh-pages/API.md#unsafe-escape-hatch\n    const renderCanvas = this.$container?.getElementsByTagName('canvas')[0];\n    if (renderCanvas) {\n      renderCanvas.width = width;\n      renderCanvas.height = height;\n      renderCanvas.style.width = width / 2 + 'px';\n      renderCanvas.style.height = height / 2 + 'px';\n    }\n    this.gl._gl.viewport(x, y, width, height);\n    this.gl._refresh();\n  };\n\n  public readPixels = (options: IReadPixelsOptions) => {\n    const { framebuffer, x, y, width, height } = options;\n    const readPixelsOptions: regl.ReadOptions = {\n      x,\n      y,\n      width,\n      height,\n    };\n    if (framebuffer) {\n      readPixelsOptions.framebuffer = (framebuffer as ReglFramebuffer).get();\n    }\n    return this.gl.read(readPixelsOptions);\n  };\n\n  public getViewportSize = () => {\n    return {\n      width: this.gl._gl.drawingBufferWidth,\n      height: this.gl._gl.drawingBufferHeight,\n    };\n  };\n\n  public getContainer = () => {\n    return this.$container;\n  };\n\n  public destroy = () => {\n    // @see https://github.com/regl-project/regl/blob/gh-pages/API.md#clean-up\n    this.gl.destroy();\n  };\n}\n"],"file":"index.js"}