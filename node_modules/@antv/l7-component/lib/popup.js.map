{"version":3,"sources":["../src/popup.ts"],"names":["Popup","cfg","popupOption","mapsService","lngLat","content","closeButton","timeoutInstance","container","tip","scene","getdefault","get","TYPES","IMapService","on","update","closeOnClick","setTimeout","onClickClose","emit","remove","addTo","html","frag","window","document","createDocumentFragment","temp","createElement","child","innerHTML","firstChild","appendChild","setDOMContent","Array","isArray","lng","lat","text","createTextNode","maxWidth","htmlNode","createContent","removeDom","off","clearTimeout","DOM","create","setAttribute","addEventListener","tagName","className","el","undefined","node","parentNode","removeChild","offsets","anchor","anchorType","BOTTOM","e","stopPropagation","hasPosition","markerContainer","getMarkerContainer","creatDom","split","forEach","name","classList","add","style","updatePosition","setTransform","anchorTranslate","pos","lngLatToContainer","left","x","top","y","EventEmitter"],"mappings":"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","sourcesContent":["import {\n  ILngLat,\n  IMapService,\n  IPoint,\n  IPopup,\n  IPopupOption,\n  TYPES,\n} from '@antv/l7-core';\nimport {\n  anchorTranslate,\n  anchorType,\n  applyAnchorClass,\n  bindAll,\n  DOM,\n} from '@antv/l7-utils';\nimport { EventEmitter } from 'eventemitter3';\nimport { Container } from 'inversify';\n\n/** colse event */\n\nexport default class Popup extends EventEmitter implements IPopup {\n  private popupOption: IPopupOption;\n  private mapsService: IMapService<unknown>;\n  private lngLat: ILngLat;\n  private content: HTMLElement;\n  private closeButton: HTMLElement;\n  private timeoutInstance: any;\n  private container: HTMLElement;\n  private tip: HTMLElement;\n  private scene: Container;\n\n  constructor(cfg?: Partial<IPopupOption>) {\n    super();\n    this.popupOption = {\n      ...this.getdefault(),\n      ...cfg,\n    };\n    bindAll(['update', 'onClickClose', 'remove'], this);\n  }\n\n  public addTo(scene: Container) {\n    this.mapsService = scene.get<IMapService>(TYPES.IMapService);\n    this.mapsService.on('camerachange', this.update);\n    this.scene = scene;\n    this.update();\n    if (this.popupOption.closeOnClick) {\n      this.timeoutInstance = setTimeout(() => {\n        this.mapsService.on('click', this.onClickClose);\n      }, 30);\n    }\n    this.emit('open');\n    return this;\n  }\n\n  public close(): void {\n    this.remove();\n  }\n\n  public open(): void {\n    this.addTo(this.scene);\n  }\n\n  public setHTML(html: string) {\n    const frag = window.document.createDocumentFragment();\n    const temp = window.document.createElement('body');\n    let child: ChildNode | null;\n    temp.innerHTML = html;\n    while (true) {\n      child = temp.firstChild;\n      if (!child) {\n        break;\n      }\n      frag.appendChild(child);\n    }\n\n    return this.setDOMContent(frag);\n  }\n\n  public setLnglat(lngLat: ILngLat | number[]): this {\n    this.lngLat = lngLat as ILngLat;\n    if (Array.isArray(lngLat)) {\n      this.lngLat = {\n        lng: lngLat[0],\n        lat: lngLat[1],\n      };\n    }\n    if (this.mapsService) {\n      this.mapsService.on('camerachange', this.update);\n    }\n    this.update();\n    return this;\n  }\n  public getLnglat(): ILngLat {\n    return this.lngLat;\n  }\n  public setText(text: string) {\n    return this.setDOMContent(window.document.createTextNode(text));\n  }\n\n  public setMaxWidth(maxWidth: string): this {\n    this.popupOption.maxWidth = maxWidth;\n    this.update();\n    return this;\n  }\n\n  public setDOMContent(htmlNode: ChildNode | DocumentFragment) {\n    this.createContent();\n    this.content.appendChild(htmlNode);\n    this.update();\n    return this;\n  }\n\n  // 移除popup\n  public remove() {\n    if (this.content) {\n      this.removeDom(this.content);\n    }\n\n    if (this.container) {\n      this.removeDom(this.container);\n      delete this.container;\n    }\n    if (this.mapsService) {\n      // TODO: mapbox AMap 事件同步\n      this.mapsService.off('camerachange', this.update);\n      this.mapsService.off('click', this.onClickClose);\n      delete this.mapsService;\n    }\n    clearTimeout(this.timeoutInstance);\n    this.emit('close');\n    return this;\n  }\n  public isOpen() {\n    return !!this.mapsService;\n  }\n\n  private createContent() {\n    if (this.content) {\n      DOM.remove(this.content);\n    }\n    this.content = DOM.create('div', 'l7-popup-content', this.container);\n    if (this.popupOption.closeButton) {\n      this.closeButton = DOM.create(\n        'button',\n        'l7-popup-close-button',\n        this.content,\n      );\n      // this.closeButton.type = 'button';\n      this.closeButton.setAttribute('aria-label', 'Close popup');\n      this.closeButton.innerHTML = '&#215;';\n      this.closeButton.addEventListener('click', this.onClickClose);\n    }\n  }\n\n  private creatDom(tagName: string, className: string, container: HTMLElement) {\n    const el = window.document.createElement(tagName);\n    if (className !== undefined) {\n      el.className = className;\n    }\n    if (container) {\n      container.appendChild(el);\n    }\n    return el;\n  }\n\n  private removeDom(node: ChildNode) {\n    if (node.parentNode) {\n      node.parentNode.removeChild(node);\n    }\n  }\n\n  private getdefault() {\n    return {\n      closeButton: true,\n      closeOnClick: true,\n      maxWidth: '240px',\n      offsets: [0, 0],\n      anchor: anchorType.BOTTOM,\n      className: '',\n    };\n  }\n\n  private onClickClose(e: Event) {\n    if (e.stopPropagation) {\n      e.stopPropagation();\n    }\n    this.remove();\n  }\n\n  private update() {\n    const hasPosition = this.lngLat;\n    const { className, maxWidth, anchor } = this.popupOption;\n    if (!this.mapsService || !hasPosition || !this.content) {\n      return;\n    }\n    const markerContainer = this.mapsService.getMarkerContainer();\n    if (!this.container && markerContainer) {\n      this.container = this.creatDom(\n        'div',\n        'l7-popup',\n        markerContainer.parentNode as HTMLElement,\n      );\n\n      this.tip = this.creatDom('div', 'l7-popup-tip', this.container);\n      this.container.appendChild(this.content);\n      if (className) {\n        className\n          .split(' ')\n          .forEach((name) => this.container.classList.add(name));\n      }\n      this.container.addEventListener('mousedown', (e) => {\n        e.stopPropagation();\n      });\n      this.container.addEventListener('click', (e) => {\n        e.stopPropagation();\n      });\n    }\n    if (maxWidth && this.container.style.maxWidth !== maxWidth) {\n      this.container.style.maxWidth = maxWidth;\n    }\n\n    this.updatePosition();\n    DOM.setTransform(this.container, `${anchorTranslate[anchor]}`);\n    applyAnchorClass(this.container, anchor, 'popup');\n  }\n\n  private updatePosition() {\n    if (!this.mapsService) {\n      return;\n    }\n    const { lng, lat } = this.lngLat;\n    const { offsets } = this.popupOption;\n    const pos = this.mapsService.lngLatToContainer([lng, lat]);\n    this.container.style.left = pos.x + offsets[0] + 'px';\n    this.container.style.top = pos.y - offsets[1] + 'px';\n  }\n}\n"],"file":"popup.js"}