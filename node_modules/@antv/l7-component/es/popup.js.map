{"version":3,"sources":["../src/popup.ts"],"names":["TYPES","anchorTranslate","anchorType","applyAnchorClass","bindAll","DOM","EventEmitter","Popup","cfg","popupOption","mapsService","lngLat","content","closeButton","timeoutInstance","container","tip","scene","getdefault","get","IMapService","on","update","closeOnClick","setTimeout","onClickClose","emit","remove","addTo","html","frag","window","document","createDocumentFragment","temp","createElement","child","innerHTML","firstChild","appendChild","setDOMContent","Array","isArray","lng","lat","text","createTextNode","maxWidth","htmlNode","createContent","removeDom","off","clearTimeout","create","setAttribute","addEventListener","tagName","className","el","undefined","node","parentNode","removeChild","offsets","anchor","BOTTOM","e","stopPropagation","hasPosition","markerContainer","getMarkerContainer","creatDom","split","forEach","name","classList","add","style","updatePosition","setTransform","pos","lngLatToContainer","left","x","top","y"],"mappings":"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","sourcesContent":["import {\n  ILngLat,\n  IMapService,\n  IPoint,\n  IPopup,\n  IPopupOption,\n  TYPES,\n} from '@antv/l7-core';\nimport {\n  anchorTranslate,\n  anchorType,\n  applyAnchorClass,\n  bindAll,\n  DOM,\n} from '@antv/l7-utils';\nimport { EventEmitter } from 'eventemitter3';\nimport { Container } from 'inversify';\n\n/** colse event */\n\nexport default class Popup extends EventEmitter implements IPopup {\n  private popupOption: IPopupOption;\n  private mapsService: IMapService<unknown>;\n  private lngLat: ILngLat;\n  private content: HTMLElement;\n  private closeButton: HTMLElement;\n  private timeoutInstance: any;\n  private container: HTMLElement;\n  private tip: HTMLElement;\n  private scene: Container;\n\n  constructor(cfg?: Partial<IPopupOption>) {\n    super();\n    this.popupOption = {\n      ...this.getdefault(),\n      ...cfg,\n    };\n    bindAll(['update', 'onClickClose', 'remove'], this);\n  }\n\n  public addTo(scene: Container) {\n    this.mapsService = scene.get<IMapService>(TYPES.IMapService);\n    this.mapsService.on('camerachange', this.update);\n    this.scene = scene;\n    this.update();\n    if (this.popupOption.closeOnClick) {\n      this.timeoutInstance = setTimeout(() => {\n        this.mapsService.on('click', this.onClickClose);\n      }, 30);\n    }\n    this.emit('open');\n    return this;\n  }\n\n  public close(): void {\n    this.remove();\n  }\n\n  public open(): void {\n    this.addTo(this.scene);\n  }\n\n  public setHTML(html: string) {\n    const frag = window.document.createDocumentFragment();\n    const temp = window.document.createElement('body');\n    let child: ChildNode | null;\n    temp.innerHTML = html;\n    while (true) {\n      child = temp.firstChild;\n      if (!child) {\n        break;\n      }\n      frag.appendChild(child);\n    }\n\n    return this.setDOMContent(frag);\n  }\n\n  public setLnglat(lngLat: ILngLat | number[]): this {\n    this.lngLat = lngLat as ILngLat;\n    if (Array.isArray(lngLat)) {\n      this.lngLat = {\n        lng: lngLat[0],\n        lat: lngLat[1],\n      };\n    }\n    if (this.mapsService) {\n      this.mapsService.on('camerachange', this.update);\n    }\n    this.update();\n    return this;\n  }\n  public getLnglat(): ILngLat {\n    return this.lngLat;\n  }\n  public setText(text: string) {\n    return this.setDOMContent(window.document.createTextNode(text));\n  }\n\n  public setMaxWidth(maxWidth: string): this {\n    this.popupOption.maxWidth = maxWidth;\n    this.update();\n    return this;\n  }\n\n  public setDOMContent(htmlNode: ChildNode | DocumentFragment) {\n    this.createContent();\n    this.content.appendChild(htmlNode);\n    this.update();\n    return this;\n  }\n\n  // 移除popup\n  public remove() {\n    if (this.content) {\n      this.removeDom(this.content);\n    }\n\n    if (this.container) {\n      this.removeDom(this.container);\n      delete this.container;\n    }\n    if (this.mapsService) {\n      // TODO: mapbox AMap 事件同步\n      this.mapsService.off('camerachange', this.update);\n      this.mapsService.off('click', this.onClickClose);\n      delete this.mapsService;\n    }\n    clearTimeout(this.timeoutInstance);\n    this.emit('close');\n    return this;\n  }\n  public isOpen() {\n    return !!this.mapsService;\n  }\n\n  private createContent() {\n    if (this.content) {\n      DOM.remove(this.content);\n    }\n    this.content = DOM.create('div', 'l7-popup-content', this.container);\n    if (this.popupOption.closeButton) {\n      this.closeButton = DOM.create(\n        'button',\n        'l7-popup-close-button',\n        this.content,\n      );\n      // this.closeButton.type = 'button';\n      this.closeButton.setAttribute('aria-label', 'Close popup');\n      this.closeButton.innerHTML = '&#215;';\n      this.closeButton.addEventListener('click', this.onClickClose);\n    }\n  }\n\n  private creatDom(tagName: string, className: string, container: HTMLElement) {\n    const el = window.document.createElement(tagName);\n    if (className !== undefined) {\n      el.className = className;\n    }\n    if (container) {\n      container.appendChild(el);\n    }\n    return el;\n  }\n\n  private removeDom(node: ChildNode) {\n    if (node.parentNode) {\n      node.parentNode.removeChild(node);\n    }\n  }\n\n  private getdefault() {\n    return {\n      closeButton: true,\n      closeOnClick: true,\n      maxWidth: '240px',\n      offsets: [0, 0],\n      anchor: anchorType.BOTTOM,\n      className: '',\n    };\n  }\n\n  private onClickClose(e: Event) {\n    if (e.stopPropagation) {\n      e.stopPropagation();\n    }\n    this.remove();\n  }\n\n  private update() {\n    const hasPosition = this.lngLat;\n    const { className, maxWidth, anchor } = this.popupOption;\n    if (!this.mapsService || !hasPosition || !this.content) {\n      return;\n    }\n    const markerContainer = this.mapsService.getMarkerContainer();\n    if (!this.container && markerContainer) {\n      this.container = this.creatDom(\n        'div',\n        'l7-popup',\n        markerContainer.parentNode as HTMLElement,\n      );\n\n      this.tip = this.creatDom('div', 'l7-popup-tip', this.container);\n      this.container.appendChild(this.content);\n      if (className) {\n        className\n          .split(' ')\n          .forEach((name) => this.container.classList.add(name));\n      }\n      this.container.addEventListener('mousedown', (e) => {\n        e.stopPropagation();\n      });\n      this.container.addEventListener('click', (e) => {\n        e.stopPropagation();\n      });\n    }\n    if (maxWidth && this.container.style.maxWidth !== maxWidth) {\n      this.container.style.maxWidth = maxWidth;\n    }\n\n    this.updatePosition();\n    DOM.setTransform(this.container, `${anchorTranslate[anchor]}`);\n    applyAnchorClass(this.container, anchor, 'popup');\n  }\n\n  private updatePosition() {\n    if (!this.mapsService) {\n      return;\n    }\n    const { lng, lat } = this.lngLat;\n    const { offsets } = this.popupOption;\n    const pos = this.mapsService.lngLatToContainer([lng, lat]);\n    this.container.style.left = pos.x + offsets[0] + 'px';\n    this.container.style.top = pos.y - offsets[1] + 'px';\n  }\n}\n"],"file":"popup.js"}